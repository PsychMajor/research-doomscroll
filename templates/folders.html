<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Folders - Research Doomscroll</title>
    <link rel="stylesheet" href="/static/style.css">
    <script>
        console.log('üì¶ [FOLDERS] Script version 2025-11-02T12:00:00Z loaded');
        // Define functions in global scope immediately (before page loads)
        window.openAddFolderModal = function() {
            console.log('Opening modal...');
            const modal = document.getElementById('addFolderModal');
            if (modal) {
                modal.classList.add('active');
                console.log('Modal opened, classes:', modal.classList);
                // Focus on input field
                const input = modal.querySelector('input[name="folder_name"]');
                if (input) {
                    setTimeout(() => input.focus(), 100);
                }
            } else {
                console.error('Modal element not found!');
            }
        };

        window.closeAddFolderModal = function() {
            console.log('Closing modal...');
            const modal = document.getElementById('addFolderModal');
            if (modal) {
                modal.classList.remove('active');
            }
        };

        window.deleteFolder = function(folderId, folderName) {
            if (confirm(`Are you sure you want to delete the folder "${folderName}"? This cannot be undone.`)) {
                console.log('Deleting folder:', folderId);
                
                // Create a form and submit it
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/folders/delete';
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'folder_id';
                input.value = folderId;
                
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        };
    </script>
</head>
<body class="folders-page">
    <div class="container">
        <header class="header">
            <div class="header-top">
                <div class="header-title">
                    <h1>Research Doomscroll</h1>
                    <p class="subtitle">Infinite scroll through research papers</p>
                </div>
                <div class="header-actions">
                    {% if user and user.id != 'anonymous' %}
                        <div class="user-info">
                            <img src="{{ user.picture }}" alt="{{ user.name }}" class="user-avatar">
                            <span class="user-name">Welcome {{ user.name.split()[0] if user.name else user.email.split('@')[0] }}</span>
                            <a href="/logout" class="btn-logout">Logout</a>
                        </div>
                    {% else %}
                        <a href="/login" class="btn-login">Sign in with Google</a>
                    {% endif %}
                </div>
            </div>
        </header>
        
        <!-- Navigation Menu -->
        <nav class="nav-menu">
            <a href="/?show_form_only=true" class="nav-item">Search</a>
            <div class="nav-item-dropdown">
                <a href="/folders" class="nav-item active">Folders</a>
                <div class="dropdown-menu">
                    {% if folders %}
                        {% for folder in folders %}
                            {% if folder.id == 'likes' %}
                                <a href="/likes" class="dropdown-item">{{ folder.name }}</a>
                            {% else %}
                                <a href="/folder/{{ folder.id }}" class="dropdown-item">{{ folder.name }}</a>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <a href="/likes" class="dropdown-item">Likes</a>
                    {% endif %}
                </div>
            </div>
            <a href="#Following" class="nav-item">Following</a>
            <a href="#Recommended" class="nav-item">Recommended</a>
            <a href="#Contact" class="nav-item">Contact</a>
        </nav>

        <div class="folders-container">
            <div class="folders-header">
                <h1>My Folders</h1>
                <p>Organize your research papers into collections</p>
            </div>

            <div class="folders-grid">
                <!-- Existing folders -->
                <div class="folder-card-wrapper">
                    <a href="/likes" class="folder-card">
                        <div class="folder-icon">
                            <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </div>
                        <h3 class="folder-name">Likes</h3>
                        <p class="folder-count">Your liked papers</p>
                    </a>
                </div>

                {% for folder in folders %}
                    {% if folder.id != 'likes' %}
                    <div class="folder-card-wrapper" style="position: relative !important; display: block !important; width: 100% !important;">
                        <a href="/folder/{{ folder.id }}" class="folder-card">
                            <div class="folder-icon">
                                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </div>
                            <h3 class="folder-name">{{ folder.name }}</h3>
                            <p class="folder-count">{{ folder.papers|length if folder.papers else 0 }} paper{{ 's' if (folder.papers|length if folder.papers else 0) != 1 else '' }}</p>
                        </a>
                        <button class="delete-folder-btn" style="position: absolute !important; top: 8px !important; right: 8px !important; z-index: 10 !important; opacity: 0;" onclick="event.preventDefault(); event.stopPropagation(); deleteFolder('{{ folder.id }}', '{{ folder.name }}');" title="Delete folder">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: block; pointer-events: none;">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                        </button>
                    </div>
                    {% endif %}
                {% endfor %}

                <!-- Add new folder button -->
                <div class="folder-card-wrapper">
                    <div class="folder-card add-folder" onclick="openAddFolderModal()">
                        <div class="add-folder-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </div>
                        <p class="add-folder-text">Add Folder</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Folder Modal -->
    <div class="modal-overlay" id="addFolderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Folder</h2>
                <p>Give your folder a name</p>
            </div>
            <form class="modal-form" method="POST" action="/folders/add">
                <input 
                    type="text" 
                    name="folder_name" 
                    class="modal-input" 
                    placeholder="e.g., Machine Learning, CRISPR Research"
                    required
                    autofocus
                >
                <div class="modal-actions">
                    <button type="button" class="modal-btn modal-btn-secondary" onclick="closeAddFolderModal()">
                        Cancel
                    </button>
                    <button type="submit" class="modal-btn modal-btn-primary">
                        Create Folder
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Track initialized elements to prevent duplicate listeners (mutable for cache clearing)
        let initializedElements = new WeakSet();

        // Initialize modal event listeners
        function initializeModalListeners() {
            console.log('üîß [FOLDERS] Initializing modal listeners and hover effects...');
            console.log('üîß [FOLDERS] Document ready state:', document.readyState);
            
            const modal = document.getElementById('addFolderModal');
            if (modal && !modal.dataset.initialized) {
                // Close modal on outside click
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeAddFolderModal();
                    }
                });

                // Close modal on Escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        closeAddFolderModal();
                    }
                });
                
                modal.dataset.initialized = 'true';
                console.log('‚úÖ [FOLDERS] Modal listeners initialized');
            }

            // Initialize hover effects for folder cards
            const folderWrappers = document.querySelectorAll('.folder-card-wrapper');
            console.log(`üîß [FOLDERS] Found ${folderWrappers.length} folder wrapper(s)`);
            
            folderWrappers.forEach((wrapper, index) => {
                const deleteBtn = wrapper.querySelector('.delete-folder-btn');
                console.log(`üîß [FOLDERS] Wrapper ${index}:`, {
                    hasDeleteBtn: !!deleteBtn,
                    wrapperDisplay: window.getComputedStyle(wrapper).display,
                    wrapperPosition: window.getComputedStyle(wrapper).position,
                    alreadyInitialized: initializedElements.has(wrapper)
                });
                
                if (deleteBtn) {
                    // Skip if already initialized (prevents duplicate listeners)
                    if (initializedElements.has(wrapper)) {
                        console.log(`‚è≠Ô∏è [FOLDERS] Wrapper ${index} already initialized, skipping`);
                        return;
                    }

                    // Log initial button state
                    const initialStyles = window.getComputedStyle(deleteBtn);
                    console.log(`üîß [FOLDERS] Delete button ${index} initial state:`, {
                        position: initialStyles.position,
                        top: initialStyles.top,
                        right: initialStyles.right,
                        opacity: initialStyles.opacity,
                        display: initialStyles.display,
                        zIndex: initialStyles.zIndex
                    });
                    
                    // Ensure initial state is hidden
                    deleteBtn.style.opacity = '0';
                    console.log(`‚úÖ [FOLDERS] Set delete button ${index} opacity to 0`);
                    
                    // Change color when hovering directly over the button
                    deleteBtn.addEventListener('mouseenter', function() {
                        console.log(`üñ±Ô∏è [FOLDERS] Mouse entered delete button ${index}`);
                        this.style.backgroundColor = 'rgba(239, 68, 68, 0.2)';
                        this.style.borderColor = '#ef4444';
                        this.style.color = '#ef4444';
                        this.style.transform = 'scale(1.1)';
                    });
                    deleteBtn.addEventListener('mouseleave', function() {
                        console.log(`üñ±Ô∏è [FOLDERS] Mouse left delete button ${index}`);
                        this.style.backgroundColor = 'rgba(21, 32, 43, 0.9)';
                        this.style.borderColor = '#38444d';
                        this.style.color = '#8899a6';
                        this.style.transform = 'scale(1)';
                    });
                    
                    // Show/hide trash icon when hovering over the entire wrapper
                    wrapper.addEventListener('mouseenter', function() {
                        console.log(`üñ±Ô∏è [FOLDERS] Mouse entered wrapper ${index}, showing delete button`);
                        console.log(`üñ±Ô∏è [FOLDERS] Current opacity before show:`, deleteBtn.style.opacity);
                        deleteBtn.style.opacity = '1';
                        console.log(`üñ±Ô∏è [FOLDERS] Set opacity to 1`);
                    });
                    wrapper.addEventListener('mouseleave', function() {
                        console.log(`üñ±Ô∏è [FOLDERS] Mouse left wrapper ${index}, hiding delete button`);
                        deleteBtn.style.opacity = '0';
                        // Reset button styles when leaving wrapper
                        deleteBtn.style.backgroundColor = 'rgba(21, 32, 43, 0.9)';
                        deleteBtn.style.borderColor = '#38444d';
                        deleteBtn.style.color = '#8899a6';
                        deleteBtn.style.transform = 'scale(1)';
                        console.log(`üñ±Ô∏è [FOLDERS] Reset button ${index} styles`);
                    });
                    
                    // Mark as initialized
                    initializedElements.add(wrapper);
                    console.log(`‚úÖ [FOLDERS] Hover listeners attached to wrapper ${index}`);
                }
            });
            
            console.log('‚úÖ [FOLDERS] All hover effects initialized');
        }

        // Reset trash icon visibility when page becomes visible (handles browser back/forward)
        function resetTrashIconVisibility() {
            console.log('üîÑ [FOLDERS] Resetting trash icon visibility...');
            const deleteButtons = document.querySelectorAll('.delete-folder-btn');
            console.log(`üîÑ [FOLDERS] Found ${deleteButtons.length} delete button(s) to reset`);
            
            deleteButtons.forEach((btn, index) => {
                const beforeStyles = window.getComputedStyle(btn);
                console.log(`üîÑ [FOLDERS] Button ${index} before reset:`, {
                    opacity: beforeStyles.opacity,
                    position: beforeStyles.position,
                    top: beforeStyles.top,
                    right: beforeStyles.right
                });
                
                btn.style.opacity = '0';
                btn.style.backgroundColor = 'rgba(21, 32, 43, 0.9)';
                btn.style.borderColor = '#38444d';
                btn.style.color = '#8899a6';
                btn.style.transform = 'scale(1)';
                
                console.log(`‚úÖ [FOLDERS] Button ${index} reset complete`);
            });
            
            console.log('‚úÖ [FOLDERS] All trash icons reset');
        }

        // Listen for page visibility changes (when user navigates back)
        document.addEventListener('visibilitychange', function() {
            console.log('üëÅÔ∏è [FOLDERS] Visibility changed, hidden:', document.hidden);
            if (!document.hidden) {
                resetTrashIconVisibility();
                console.log('üëÅÔ∏è [FOLDERS] Page became visible, forcing reinitialization');
                forceInitialization(true);
            }
        });

        // Listen for pageshow event (when page is restored from cache)
        window.addEventListener('pageshow', function(event) {
            console.log('üìÑ [FOLDERS] Pageshow event, persisted:', event.persisted);
            if (event.persisted) {
                // Page was restored from bfcache
                console.log('üíæ [FOLDERS] Page restored from cache, clearing WeakSet and reinitializing...');
                // Clear the initialized elements so we can reinitialize everything
                initializedElements = new WeakSet();
                resetTrashIconVisibility();
                // Force complete reinitialization
                setTimeout(() => {
                    console.log('üõ†Ô∏è [FOLDERS] Running forceInitialization after bfcache restore');
                    forceInitialization(true);
                }, 100);
            } else {
                console.log('üìÑ [FOLDERS] Fresh page load (not from cache)');
            }
        });

        // Observe changes to the folders grid to reinitialize when content changes
        function observeFoldersGrid() {
            const foldersGrid = document.querySelector('.folders-grid');
            if (!foldersGrid) {
                console.warn('‚ö†Ô∏è [FOLDERS] Folders grid not found for observation');
                // Retry after a short delay in case grid isn't rendered yet
                setTimeout(() => {
                    console.log('üîÑ [FOLDERS] Retrying folders grid observation...');
                    observeFoldersGrid();
                }, 100);
                return;
            }

            console.log('üëÄ [FOLDERS] Setting up MutationObserver on folders grid');

            const observer = new MutationObserver((mutations) => {
                console.log('üîÑ [FOLDERS] DOM mutation detected:', mutations.length, 'mutation(s)');
                
                mutations.forEach((mutation, idx) => {
                    console.log(`üîÑ [FOLDERS] Mutation ${idx}:`, {
                        type: mutation.type,
                        addedNodes: mutation.addedNodes.length,
                        removedNodes: mutation.removedNodes.length
                    });
                });
                
                // Check if folder cards were added or removed
                const hasFolderChanges = mutations.some(mutation => {
                    return Array.from(mutation.addedNodes).some(node => 
                        node.classList && (node.classList.contains('folder-card-wrapper') || node.classList.contains('folder-card'))
                    ) || Array.from(mutation.removedNodes).some(node =>
                        node.classList && (node.classList.contains('folder-card-wrapper') || node.classList.contains('folder-card'))
                    );
                });

                if (hasFolderChanges) {
                    console.log('üì¶ [FOLDERS] Folder cards changed, reinitializing hover effects...');
                    // Small delay to ensure DOM is fully updated
                    setTimeout(() => {
                        initializeModalListeners();
                    }, 50);
                } else {
                    console.log('‚è≠Ô∏è [FOLDERS] No folder card changes detected, skipping reinitialization');
                }
            });

            observer.observe(foldersGrid, {
                childList: true,
                subtree: true
            });

            console.log('‚úÖ [FOLDERS] MutationObserver active');
        }

        // Force immediate initialization on page load
        function forceInitialization(isFromCache = false) {
            console.log(`üöÄ [FOLDERS] Force initialization triggered (${isFromCache ? 'from cache restore' : 'normal load'})`);
            // Wait for any pending renders
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    console.log(`üé¨ [FOLDERS] Executing force initialization after render frames (${isFromCache ? 'cache restore' : 'normal'})`);
                    
                    // Force refresh all folder card styles to ensure correct rendering
                    const allFolderCards = document.querySelectorAll('.folder-card');
                    console.log(`üé® [FOLDERS] Force refreshing styles for ${allFolderCards.length} folder cards (fromCache=${isFromCache})`);
                    
                    allFolderCards.forEach((card, idx) => {
                        const icon = card.querySelector('.folder-icon');
                        const svg = card.querySelector('.folder-icon svg');
                        
                        if (icon) {
                            // Force reapply icon styles
                            icon.style.marginBottom = '12px';
                            icon.style.color = '#1da1f2';
                        }
                        
                        if (svg) {
                            svg.style.display = 'block';
                        }
                        
                        console.log(`üé® [FOLDERS] Refreshed styles for card ${idx} (fromCache=${isFromCache})`);
                    });
                    
                    initializeModalListeners();
                });
            });
        }

        try {
            const navEntries = performance.getEntriesByType('navigation');
            const navType = navEntries && navEntries.length > 0 ? navEntries[0].type : undefined;
            if (navType === 'back_forward') {
                console.log('üîô [FOLDERS] Detected back/forward navigation via PerformanceNavigationTiming');
                forceInitialization(true);
            } else if (performance.navigation && performance.navigation.type === performance.navigation.TYPE_BACK_FORWARD) {
                console.log('üîô [FOLDERS] Detected back/forward navigation via legacy PerformanceNavigation');
                forceInitialization(true);
            } else {
                console.log('üì¶ [FOLDERS] Navigation detection result:', navType ?? performance.navigation?.type ?? 'unknown');
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è [FOLDERS] Navigation detection failed:', err);
        }

        // Initialize immediately if DOM is already loaded, otherwise wait
        console.log('üöÄ [FOLDERS] Script loaded, ready state:', document.readyState);
        if (document.readyState === 'loading') {
            console.log('‚è≥ [FOLDERS] Waiting for DOMContentLoaded...');
            document.addEventListener('DOMContentLoaded', function() {
                initializeModalListeners();
                observeFoldersGrid();
                forceInitialization(false);
            });
        } else {
            console.log('‚úÖ [FOLDERS] DOM already loaded, initializing now');
            initializeModalListeners();
            observeFoldersGrid();
            // Force another initialization after render to catch any late-rendered elements
            forceInitialization(false);
        }
    </script>
</body>
</html>
